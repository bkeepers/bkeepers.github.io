<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Testing Facebook with Cucumber</title>
  <meta name="description" content="a blog about code">
  <meta name="author" content="Brandon Keepers">
  <meta name="verify-v1" content="UwU5mecrHiDTPVlphLl729aaRCmyz93jrs+ER3RP4Pw=">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="google-site-verification" content="h4QNmQOrsvnIEsMH5GS3s4_jV3ZAZgrEoZdL4RsbOMI" />

  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link rel="stylesheet" href="/assets/site-74f5816ea43e741e34a7f567265596b9.css">

  <link rel="openid.server" href="http://www.myopenid.com/server">
  <link rel="openid.delegate" href="http://bkeepers.myopenid.com/">
  <link href="http://feeds.feedburner.com/opensoul" rel="alternate" title="opensoul.org" type="application/atom+xml">

  <!-- FIXME:  -->
</head>
<body>
<div class="container">
  <header>
    <h1><a href="/">opensoul.org</a></h1>
  </header>

  <div id="content">
    <article>
  <h1 class="small">Testing Facebook with Cucumber</h1>
  <p class="meta">
    <span class="date">March  6, 2009</span>
    <span class="tags">
      
        cucumber,
      
        facebook,
      
        rails,
      
        testing
      
    </span>
  </p>
  <div class="body"><p>For those that haven&#8217;t heard: <a href="http://cukes.info">Cucumber</a> is pretty much the greatest thing since sliced bread. It dramatically improved the quality and stability of our applications, and the <a href="http://dannorth.net/whats-in-a-story">outside-in</a> approach that it encourages forces you to stay focused on what&#8217;s important.</p>
<p>When we started working on a Facebook application a few months ago, we couldn&#8217;t fathom not using Cucumber. So we had to figure out a way to test it.  It took us a few months to evolve it to a point where we could extract it, but this week we <a href="http://github.com/mmangino/facebooker/commit/cad4ef415f297bfd0ed6ab67bf9d11f4d7ce5150">pushed a change to Facebooker</a> to make life a little easier. So grab the latest version of Facebooker and keep on reading…</p>
<p>First, in <code>features/support/env.rb</code>, replace the default Rails world with the one in Facebooker:</p>
<div class="highlight"><pre><code class="ruby"><span class="c1"># require &#39;cucumber/rails/world&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;facebooker/rails/cucumber&#39;</span>
</code></pre></div><h3>Given I am logged in as a Facebook user</h3>
<p>Most of our Facebook application requires that a user be logged in. So most of our scenarios started with &#8220;Given I am logged in as a Facebook user&#8221;.</p>
<pre>
Scenario: Uploading a video
  Given I am logged in as a Facebook user
  When I upload a video
  Then I can see a video on my blog
</pre>
<p>And here is our implementation for that step:</p>
<div class="highlight"><pre><code class="ruby"><span class="no">Given</span> <span class="s2">&quot;I am logged in as a Facebook user&quot;</span> <span class="k">do</span>
  <span class="vi">@current_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span> <span class="ss">:facebook_id</span> <span class="o">=&gt;</span> <span class="mi">1</span>
  <span class="vi">@current_user</span><span class="o">.</span><span class="n">facebook_user</span><span class="o">.</span><span class="n">friends</span> <span class="o">=</span> <span class="o">[</span>
    <span class="no">Facebooker</span><span class="o">::</span><span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:id</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Bob&#39;</span><span class="p">),</span>
    <span class="no">Facebooker</span><span class="o">::</span><span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:id</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Sam&#39;</span><span class="p">)</span>
  <span class="o">]</span>
  <span class="vi">@integration_session</span><span class="o">.</span><span class="n">default_request_params</span><span class="o">.</span><span class="n">merge!</span><span class="p">(</span>
    <span class="ss">:fb_sig_user</span> <span class="o">=&gt;</span> <span class="vi">@current_user</span><span class="o">.</span><span class="n">facebook_id</span><span class="p">,</span>
    <span class="ss">:fb_sig_friends</span> <span class="o">=&gt;</span> <span class="vi">@current_user</span><span class="o">.</span><span class="n">facebook_user</span><span class="o">.</span><span class="n">friends</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
  <span class="p">)</span>
<span class="k">end</span>
</code></pre></div><p>Our application has a <code>User</code> model with a <code>facebook_id</code> attribute and a <code>#facebook_user</code> method which returned an instance of <code>Facebooker::User</code>. Due to how the Facebook session is being mocked, it is important that we set our fake user&#8217;s id to 1 for now (I&#8217;ll try to figure out a way around this). We also manually add some friends for our application to use.  Lastly, we merge in our user&#8217;s id and friend ids into the default request params so that any requests we make include those parameters.</p>
<h3>Drop your…canvas</h3>
<p>There were some places in our app where requests don&#8217;t go through the canvas. For example, we have a few multipart forms, which have to submit directly to your application. To mimic this, wrap webrat calls in <code>#without_canvas</code>:</p>
<div class="highlight"><pre><code class="ruby"><span class="no">When</span> <span class="s2">&quot;I upload a video&quot;</span> <span class="k">do</span>
  <span class="n">visit</span> <span class="n">root_path</span>

  <span class="n">without_canvas</span> <span class="k">do</span>
    <span class="n">fill_in</span> <span class="s1">&#39;Title&#39;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s1">&#39;A video&#39;</span>
    <span class="n">fill_in</span> <span class="s1">&#39;Description&#39;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s1">&#39;Caption for video&#39;</span>
    <span class="n">attach_file</span> <span class="s1">&#39;Video&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">RAILS_ROOT</span><span class="si">}</span><span class="s2">/features/support/sample.mpg&quot;</span><span class="p">,</span> <span class="s2">&quot;video/mpeg&quot;</span>
    <span class="n">click_button</span> <span class="s1">&#39;Upload Video&#39;</span>
  <span class="k">end</span>
  <span class="n">follow_redirect!</span>
<span class="k">end</span>
</code></pre></div><p>Note that if your action redirects to a <span class="caps">URL</span> with <code>:canvas =&gt; true</code>, webrat will see that as an &#8220;external&#8221; redirect and won&#8217;t follow it. Just call <code>#follow_redirect!</code> and it&#8217;ll go on it&#8217;s merry way.</p>
<h3>Accessing the Facebook <span class="caps">API</span></h3>
<p>Instead of making requests to the Facebook <span class="caps">API</span> in your tests, Facebooker will try to read a canned response fixture from <code>features/support/facebook/</code>. It will give you a friendly error whenever this happens, so just follow the directions and you should be on your way.</p>
<h3>Feedback &amp; Patches</h3>
<p>I&#8217;m sure there are things that don&#8217;t work right, so let me know if you run into any troubles. If you have any ideas for making the Cucumber support better, please share them here or on the Facebooker mailing list.</p></div>

  <div id="be-social">
    <a href="https://twitter.com/share" class="twitter-share-button" data-via="bkeepers" data-lang="en" data-related="bkeepers">Tweet</a>
    <a href="https://twitter.com/bkeepers" class="twitter-follow-button" data-show-count="false" data-lang="en">Follow @bkeepers</a>
  </div>
</article>


<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  </div>

  <div id="about">
    <section>
      <p>I am <strong>Brandon Keepers</strong>. I build Internet things, usually with Ruby or JavaScript. I work at <a href="http://github.com">GitHub</a> and live in Holland, MI.</p>

      <ul id="links">
        <li>
          <a href="http://twitter.com/bkeepers">
            <span class="icon icon-mark-twitter"></span>
            Follow me on Twitter
          </a>
        </li>
        <li>
          <a href="http://github.com/bkeepers">
            <span class="icon icon-mark-github"></span>
            Follow me on GitHub
          </a>
        </li>
        <li>
          <a href="http://feeds.feedburner.com/opensoul">
            <span class="icon icon-feed"></span>
            Subscribe to the Feed
          </a>
        </li>
      </ul>
    </section>

    <section id="popular">
      <h1>Popular Posts</h1>
      <ul>
      
        <li><a href="/2012/06/05/whats-it-like-to-work-at-github/">What's it like to work at GitHub?</a></li>
      
        <li><a href="/2012/05/23/why-our-code-smells/">Why Our Code Smells</a></li>
      
        <li><a href="/2012/01/12/getting-started-with-sublime-text-2/">Getting Started with Sublime Text 2</a></li>
      
        <li><a href="/2012/01/09/the-40-standup-desk/">The $40 Standup Desk</a></li>
      
        <li><a href="/2011/11/30/haml-the-unforgivable-sin/">HAML: the unforgivable sin</a></li>
      
      </ul>
    </section>

  </div>

  <footer id="copyright">
    Copyright © 2006 - 2013 Brandon Keepers
  </footer>
</div>

<!--
FIXME:

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-817617-1");
pageTracker._trackPageview();
} catch(err) {}
</script>

<script type="text/javascript">
  (function() {
    var t = document.createElement('script');
    t.type = 'text/javascript'; t.async = true;
    t.id = 'gauges-tracker'; t.setAttribute('data-site-id', '4d5c434255da1271e4000002');
    t.src = 'http://gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>
-->
</body>
</html>
