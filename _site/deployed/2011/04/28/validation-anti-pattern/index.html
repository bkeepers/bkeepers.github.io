<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Validation Anti-Pattern</title>
  <meta name="description" content="a blog about code">
  <meta name="author" content="Brandon Keepers">
  <meta name="verify-v1" content="UwU5mecrHiDTPVlphLl729aaRCmyz93jrs+ER3RP4Pw=">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="google-site-verification" content="h4QNmQOrsvnIEsMH5GS3s4_jV3ZAZgrEoZdL4RsbOMI" />

  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link rel="stylesheet" href="/assets/site-38babed8aca4145f270d32a60b23d16d.css">

  <link rel="openid.server" href="http://www.myopenid.com/server">
  <link rel="openid.delegate" href="http://bkeepers.myopenid.com/">
  <link href="http://feeds.feedburner.com/opensoul" rel="alternate" title="opensoul.org" type="application/atom+xml">

  <!-- FIXME:  -->
</head>
<body>
<div class="container">
  <header>
    <h1><a href="/">opensoul.org</a></h1>
  </header>

  <div id="content">
    <article>
  <h1 class="small">Validation Anti-Pattern</h1>
  <p class="meta">
    <span class="date">April 28, 2011</span>
    <span class="tags">
      
        popular,
      
        rails,
      
        validations
      
    </span>
  </p>
  <div class="body"><p>Validations in ActiveRecord and other mapping frameworks are used to ensure that the data being saved to the database meets the requirements of the app. More importantly, validations are used to communicate to the end user what they need to change about the data they entered.</p>
<p>I often see people using validations to check generated attributes or an attribute set by the controller, and I think that is wrong. <strong>Validations should only be used if you to provide your user an opportunity to correct the invalid data</strong>.</p>
<p>For example, take this <a href="http://mongomapper.com">MongoMapper</a> model:</p>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">ChatMessage</span>
  <span class="kp">include</span> <span class="no">MongoMapper</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">key</span> <span class="ss">:text</span><span class="p">,</span> <span class="nb">String</span>
  <span class="n">key</span> <span class="ss">:game_id</span><span class="p">,</span> <span class="no">ObjectId</span>

  <span class="n">belongs_to</span> <span class="ss">:game</span>

  <span class="n">validates_presence_of</span> <span class="ss">:text</span><span class="p">,</span> <span class="ss">:game_id</span>
<span class="k">end</span>
</code></pre></div><p>This model is created in an action that looks something like this:</p>
<div class="highlight"><pre><code class="ruby"><span class="k">def</span> <span class="nf">create</span>
  <span class="vi">@game</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">games</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:game_id</span><span class="o">]</span><span class="p">)</span>
  <span class="vi">@chat_message</span> <span class="o">=</span> <span class="vi">@game</span><span class="o">.</span><span class="n">chat_messages</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:chat_message</span><span class="o">]</span><span class="p">)</span>
  <span class="k">if</span> <span class="vi">@chat_message</span><span class="o">.</span><span class="n">save</span>
    <span class="n">redirect_to</span> <span class="vi">@game</span>
  <span class="k">else</span>
    <span class="n">render</span> <span class="ss">:edit</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><p>The model is validating the presence of <code>text</code>, a value supplied by the user, and <code>game_id</code>. The only way that <code>game_id</code> can be blank is if there is something wrong the your controller logic. In that unlikely case, your user will be presented with the completely unhelpful error: <strong>Game cannot be blank</strong>. <code>game_id</code> should not be a validation that is shown to your user.</p>
<h2>But I don&#8217;t want to save invalid data!</h2>
<p>That&#8217;s fine. You can still use the validation callback as an opportunity to verify the data. Add an assertion that the attribute is set. Just don&#8217;t add validation errors that get displayed to your user, because no matter what they do, they won&#8217;t be able to fix the error that they are seeing. It is more helpful to raise an exception, which will show your user the standard 500 error, and notify you that you&#8217;ve got a problem with your application logic.</p>
<div class="highlight"><pre><code class="ruby"><span class="n">validate</span> <span class="ss">:validate_game_id</span>

<span class="k">def</span> <span class="nf">validate_game_id</span>
  <span class="k">raise</span> <span class="s2">&quot;game_id must be present&quot;</span> <span class="k">unless</span> <span class="nb">self</span><span class="o">.</span><span class="n">game_id?</span>
<span class="k">end</span>
</code></pre></div><h2>But what about people hacking?</h2>
<p>Do you really want to return friendly error messages to someone trying to hack your app? When trying to secure your app, you want to expose as little information as possible to potential attackers. That&#8217;s why it&#8217;s even more important to raise errors when validating internal data.</p>
<p>Return friendly error messages for values supplied by your user, and raise big ugly errors when things go wrong.</p></div>

  <div id="be-social">
    <a href="https://twitter.com/share" class="twitter-share-button" data-via="bkeepers" data-lang="en" data-related="bkeepers">Tweet</a>
    <a href="https://twitter.com/bkeepers" class="twitter-follow-button" data-show-count="false" data-lang="en">Follow @bkeepers</a>
  </div>
</article>


<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  </div>

  <div id="about">
    <section>
      <p>I am <strong>Brandon Keepers</strong>. I build Internet things, usually with Ruby or JavaScript. I work at <a href="http://github.com">GitHub</a> and live in Holland, MI.</p>

      <p id="links">
        <a href="http://twitter.com/bkeepers" class="icon icon-mark-twitter" title="Follow me on Twitter"></a>
        <a href="http://github.com/bkeepers" class="icon icon-mark-github" title="Follow me on GitHub"></a>
        <a href="http://feeds.feedburner.com/opensoul" class="icon icon-feed" title="Subscribe to the Feed"></a>
      </p>
    </section>

    <section id="popular">
      <h1>Popular Posts</h1>
      <ul>
      
        <li><a href="/2014/04/28/failure/">Lessons learned from a cancelled project</a></li>
      
        <li><a href="/2012/06/05/whats-it-like-to-work-at-github/">What's it like to work at GitHub?</a></li>
      
        <li><a href="/2012/05/23/why-our-code-smells/">Why Our Code Smells</a></li>
      
        <li><a href="/2012/01/09/the-40-standup-desk/">The $40 Standup Desk</a></li>
      
        <li><a href="/2011/11/30/haml-the-unforgivable-sin/">HAML: the unforgivable sin</a></li>
      
      </ul>

      <p><a href="/archives">View All Posts</a></p>
    </section>

  </div>

  <footer id="copyright">
    Copyright Â© 2006  - 2014 Brandon Keepers
  </footer>
</div>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-817617-1");
pageTracker._trackPageview();
} catch(err) {}
</script>

<script type="text/javascript">
  (function() {
    var t = document.createElement('script');
    t.type = 'text/javascript'; t.async = true;
    t.id = 'gauges-tracker'; t.setAttribute('data-site-id', '4d5c434255da1271e4000002');
    t.src = 'http://gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>
</body>
</html>
