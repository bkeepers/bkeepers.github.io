<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Concerning ActiveSupport::Concern</title>
  <meta name="description" content="a blog about code">
  <meta name="author" content="Brandon Keepers">
  <meta name="verify-v1" content="UwU5mecrHiDTPVlphLl729aaRCmyz93jrs+ER3RP4Pw=">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="google-site-verification" content="h4QNmQOrsvnIEsMH5GS3s4_jV3ZAZgrEoZdL4RsbOMI" />

  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link rel="stylesheet" href="/assets/site-38babed8aca4145f270d32a60b23d16d.css">

  <link rel="openid.server" href="http://www.myopenid.com/server">
  <link rel="openid.delegate" href="http://bkeepers.myopenid.com/">
  <link href="http://feeds.feedburner.com/opensoul" rel="alternate" title="opensoul.org" type="application/atom+xml">

  <!-- FIXME:  -->
</head>
<body>
<div class="container">
  <header>
    <h1><a href="/">opensoul.org</a></h1>
  </header>

  <div id="content">
    <article>
  <h1 class="small">Concerning ActiveSupport::Concern</h1>
  <p class="meta">
    <span class="date">February  8, 2011</span>
    <span class="tags">
      
        activesupport,
      
        popular,
      
        rails
      
    </span>
  </p>
  <div class="body"><p>I <a href="https://github.com/jnunemaker/mongomapper/commit/00bba859b1f68e4c112e485a2d348995699ca79c">pushed some changes to MongoMapper</a> that replace the custom plugin system with <a href="https://github.com/rails/rails/blob/master/activesupport/lib/active_support/concern.rb"><code>ActiveSupport::Concern</code></a>. <code>ActiveSupport::Concern</code> has been around for a while, but it&#8217;s capabilities are not widely known.</p>
<p>Concerns wrap up the pattern of including a module, and having it extend class methods, include instance methods, and apply some configuration.  If you&#8217;ve ever extended ActiveRecord, then you&#8217;ve likely written code that looks like this:</p>
<div class="highlight"><pre><code class="ruby"><span class="k">module</span> <span class="nn">M</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
    <span class="n">base</span><span class="o">.</span><span class="n">extend</span> <span class="no">ClassMethods</span>
    <span class="n">base</span><span class="o">.</span><span class="n">send</span> <span class="ss">:include</span><span class="p">,</span> <span class="no">InstanceMethods</span>
    <span class="n">base</span><span class="o">.</span><span class="n">some_class_method</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">ClassMethods</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">InstanceMethods</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><p>When our module <code>M</code> is included into a class, it extends the base class with <code>ClassMethods</code>, includes <code>InstanceMethods</code>, and invokes <code>some_class_method</code>.</p>
<h2>Cosmetics</h2>
<p>The first feature provided by <code>ActiveSupport::Concern</code> is purely cosmetic. Here is our module above rewritten:</p>
<div class="highlight"><pre><code class="ruby"><span class="k">module</span> <span class="nn">M</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

  <span class="n">included</span> <span class="k">do</span>
    <span class="n">some_class_method</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">ClassMethods</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">InstanceMethods</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><p>We no longer have to manually extend and include our class an instance methods.  Instead, we call <code>#included</code> with a block that gets class evaled when our concern is included.</p>
<h2>Dependency resolution</h2>
<p>The second feature provided by <code>ActiveSupport::Concern</code> is very helpful for a library like MongoMapper with numerous of modules that depend on each other.  Each concern can include the concerns that it depends on, and they will get included into the class first.  For example:</p>
<div class="highlight"><pre><code class="ruby"><span class="k">module</span> <span class="nn">A</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
  <span class="c1"># … define class and instance methods …</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">B</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
  <span class="kp">include</span> <span class="n">A</span>

  <span class="n">included</span> <span class="k">do</span>
    <span class="n">class_method_from_module_a</span>
  <span class="k">end</span>

  <span class="c1"># … define class and instance methods …</span>
<span class="k">end</span>
</code></pre></div><p>Now, users can include our module <code>B</code> into a class, and module <code>A</code> will get included.</p>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">C</span>
  <span class="kp">include</span> <span class="n">B</span>
<span class="k">end</span>
</code></pre></div><h2>How It Works</h2>
<p>I find the implementation of <code>ActiveSupport::Concern</code> fascinating. With only 3 methods and just over 20 lines of code, it cleverly overrides some of Ruby&#8217;s default behavior.  He is the source in full:</p>
<div class="highlight"><pre><code class="ruby"><span class="k">module</span> <span class="nn">ActiveSupport</span>
  <span class="k">module</span> <span class="nn">Concern</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">extended</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
      <span class="n">base</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="s2">&quot;@_dependencies&quot;</span><span class="p">,</span> <span class="o">[]</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">append_features</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">base</span><span class="o">.</span><span class="n">instance_variable_defined?</span><span class="p">(</span><span class="s2">&quot;@_dependencies&quot;</span><span class="p">)</span>
        <span class="n">base</span><span class="o">.</span><span class="n">instance_variable_get</span><span class="p">(</span><span class="s2">&quot;@_dependencies&quot;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
        <span class="k">return</span> <span class="kp">false</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">base</span> <span class="o">&lt;</span> <span class="nb">self</span>
        <span class="vi">@_dependencies</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">dep</span><span class="o">|</span> <span class="n">base</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:include</span><span class="p">,</span> <span class="n">dep</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">super</span>
        <span class="n">base</span><span class="o">.</span><span class="n">extend</span> <span class="nb">const_get</span><span class="p">(</span><span class="s2">&quot;ClassMethods&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">const_defined?</span><span class="p">(</span><span class="s2">&quot;ClassMethods&quot;</span><span class="p">)</span>
        <span class="n">base</span><span class="o">.</span><span class="n">send</span> <span class="ss">:include</span><span class="p">,</span> <span class="nb">const_get</span><span class="p">(</span><span class="s2">&quot;InstanceMethods&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">const_defined?</span><span class="p">(</span><span class="s2">&quot;InstanceMethods&quot;</span><span class="p">)</span>
        <span class="n">base</span><span class="o">.</span><span class="n">class_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="vi">@_included_block</span><span class="p">)</span> <span class="k">if</span> <span class="n">instance_variable_defined?</span><span class="p">(</span><span class="s2">&quot;@_included_block&quot;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">included</span><span class="p">(</span><span class="n">base</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">base</span><span class="o">.</span><span class="n">nil?</span>
        <span class="vi">@_included_block</span> <span class="o">=</span> <span class="n">block</span>
      <span class="k">else</span>
        <span class="k">super</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><p>Let&#8217;s walk through each section.</p>
<div class="highlight"><pre><code class="ruby"><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">extended</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
  <span class="n">base</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="s2">&quot;@_dependencies&quot;</span><span class="p">,</span> <span class="o">[]</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div><p>When our module is extended with <code>ActiveSupport::Concern</code>, Ruby calls the <code>self.extended</code> method, and passes in our module.  <code>ActiveSupport::Concern</code> sets an instance variable on our module to an empty array. This will be used to keep track of the modules that our concern depends on.</p>
<div class="highlight"><pre><code class="ruby"><span class="k">def</span> <span class="nf">append_features</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
  <span class="c1"># …</span>
<span class="k">end</span>
</code></pre></div><p>Next <code>ActiveSupport::Concern</code> defines <code>#append_features</code>, which Ruby calls on our module whenever it is included into another module. Ruby&#8217;s default implementation of this method will add constants, methods, and variables of this module to the base module. This is where <code>ActiveSupport::Concern</code> starts to get really sneaky.</p>
<div class="highlight"><pre><code class="ruby"><span class="k">if</span> <span class="n">base</span><span class="o">.</span><span class="n">instance_variable_defined?</span><span class="p">(</span><span class="s2">&quot;@_dependencies&quot;</span><span class="p">)</span>
  <span class="n">base</span><span class="o">.</span><span class="n">instance_variable_get</span><span class="p">(</span><span class="s2">&quot;@_dependencies&quot;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
  <span class="k">return</span> <span class="kp">false</span>
</code></pre></div><p>If the module that our concern is included into has the dependencies instance variable, then it is assumed to be another concern and our concern is appended to it&#8217;s dependencies. Note that <code>#super</code> is never called, and thus Ruby&#8217;s default behavior never happens. (Seriously, Ruby is awesome.)</p>
<div class="highlight"><pre><code class="ruby"><span class="k">else</span>
  <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">base</span> <span class="o">&lt;</span> <span class="nb">self</span>
  <span class="vi">@_dependencies</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">dep</span><span class="o">|</span> <span class="n">base</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:include</span><span class="p">,</span> <span class="n">dep</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">super</span>
  <span class="n">base</span><span class="o">.</span><span class="n">extend</span> <span class="nb">const_get</span><span class="p">(</span><span class="s2">&quot;ClassMethods&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">const_defined?</span><span class="p">(</span><span class="s2">&quot;ClassMethods&quot;</span><span class="p">)</span>
  <span class="n">base</span><span class="o">.</span><span class="n">send</span> <span class="ss">:include</span><span class="p">,</span> <span class="nb">const_get</span><span class="p">(</span><span class="s2">&quot;InstanceMethods&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">const_defined?</span><span class="p">(</span><span class="s2">&quot;InstanceMethods&quot;</span><span class="p">)</span>
  <span class="n">base</span><span class="o">.</span><span class="n">class_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="vi">@_included_block</span><span class="p">)</span> <span class="k">if</span> <span class="n">instance_variable_defined?</span><span class="p">(</span><span class="s2">&quot;@_included_block&quot;</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div><p>If the module that our concern is included into does not have the dependencies instance variable, then it&#8217;s a plain ol&#8217; module and we want to actually include our concern into it.  If this module has already been included then it simply returns false.  It then loops over each dependency, includes it into the base (since our dependencies are always concerns too, they will each follow this same code path), and calls <code>#super</code> to perform Ruby&#8217;s default behavior.  It then extends <code>ClassMethods</code> and includes <code>InstanceMethods</code> if they are defined.</p>
<p>Lastly, it calls <code>#class_eval</code> on a block if it&#8217;s defined, but where does this block come from?</p>
<div class="highlight"><pre><code class="ruby"><span class="k">def</span> <span class="nf">included</span><span class="p">(</span><span class="n">base</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">base</span><span class="o">.</span><span class="n">nil?</span>
    <span class="vi">@_included_block</span> <span class="o">=</span> <span class="n">block</span>
  <span class="k">else</span>
    <span class="k">super</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><p>Ruby normally calls <code>#included</code> on a module whenever it is included into another module or class, passing in the module or class that it was included into. <code>ActiveSupport::Concern</code> hijacks this method to give us a pretty syntax for declaring what should happen when our concern is included.</p>
<p>Since Ruby will still call this method whenever our module is included, the original behavior has to be preserved. If a base class or module is passed in, then Ruby is calling this method so <code>#super</code> is called. If a base module or class is not passed in, then our concern is calling it with a block that should be saved for when it actually is included.</p>
<p>It&#8217;s full of trickery, but I love it.</p></div>

  <div id="be-social">
    <a href="https://twitter.com/share" class="twitter-share-button" data-via="bkeepers" data-lang="en" data-related="bkeepers">Tweet</a>
    <a href="https://twitter.com/bkeepers" class="twitter-follow-button" data-show-count="false" data-lang="en">Follow @bkeepers</a>
  </div>
</article>


<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  </div>

  <div id="about">
    <section>
      <p>I am <strong>Brandon Keepers</strong>. I build Internet things, usually with Ruby or JavaScript. I work at <a href="http://github.com">GitHub</a> and live in Holland, MI.</p>

      <p id="links">
        <a href="http://twitter.com/bkeepers" class="icon icon-mark-twitter" title="Follow me on Twitter"></a>
        <a href="http://github.com/bkeepers" class="icon icon-mark-github" title="Follow me on GitHub"></a>
        <a href="http://feeds.feedburner.com/opensoul" class="icon icon-feed" title="Subscribe to the Feed"></a>
      </p>
    </section>

    <section id="popular">
      <h1>Popular Posts</h1>
      <ul>
      
        <li><a href="/2014/04/28/failure/">Lessons learned from a cancelled project</a></li>
      
        <li><a href="/2012/06/05/whats-it-like-to-work-at-github/">What's it like to work at GitHub?</a></li>
      
        <li><a href="/2012/05/23/why-our-code-smells/">Why Our Code Smells</a></li>
      
        <li><a href="/2012/01/09/the-40-standup-desk/">The $40 Standup Desk</a></li>
      
        <li><a href="/2011/11/30/haml-the-unforgivable-sin/">HAML: the unforgivable sin</a></li>
      
      </ul>

      <p><a href="/archives">View All Posts</a></p>
    </section>

  </div>

  <footer id="copyright">
    Copyright © 2006 - 2013 Brandon Keepers
  </footer>
</div>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-817617-1");
pageTracker._trackPageview();
} catch(err) {}
</script>

<script type="text/javascript">
  (function() {
    var t = document.createElement('script');
    t.type = 'text/javascript'; t.async = true;
    t.id = 'gauges-tracker'; t.setAttribute('data-site-id', '4d5c434255da1271e4000002');
    t.src = 'http://gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>
</body>
</html>
