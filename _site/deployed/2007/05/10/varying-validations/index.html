<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Varying validations</title>
  <meta name="description" content="a blog about code">
  <meta name="author" content="Brandon Keepers">
  <meta name="verify-v1" content="UwU5mecrHiDTPVlphLl729aaRCmyz93jrs+ER3RP4Pw=">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="google-site-verification" content="h4QNmQOrsvnIEsMH5GS3s4_jV3ZAZgrEoZdL4RsbOMI" />

  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link rel="stylesheet" href="/assets/site-6f3395796bd3c383ecd920f63f979453.css">

  <link rel="openid.server" href="http://www.myopenid.com/server">
  <link rel="openid.delegate" href="http://bkeepers.myopenid.com/">
  <link href="http://feeds.feedburner.com/opensoul" rel="alternate" title="opensoul.org" type="application/atom+xml">

  <!-- FIXME:  -->
</head>
<body>
<div class="container">
  <header>
    <h1><a href="/">opensoul.org</a></h1>
  </header>

  <div id="content">
    <article>
  <h1 class="small">Varying validations</h1>
  <p class="meta">
    <span class="date">May 10, 2007</span>
    <span class="tags">
      
        rails,
      
        validations
      
    </span>
  </p>
  <div class="body"><p>As great as Rails validations are, they&#8217;ve left much to be desired for me. I find that I often want to only do partial validations, or use a different set of validations on my model based on who is creating it (admins should be trusted more than visitors) or where it is being created (creating a user on the command line or automated process shouldn&#8217;t require acceptance of terms or confirmation of a password).</p>
<p>I&#8217;m getting close to the point where I&#8217;m so annoyed about this problem that I&#8217;m ready to solve it, but I can&#8217;t quite figure out the best way to do it. So, I ask you, how do we remedy this?</p>
<p>Here are a couple ideas that I&#8217;ve had for changing how validations work.</p>
<h3>Fatter model</h3>
<p>My first thought is to just add it to the model by declaring &#8220;sets&#8221; of validations:</p>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validations</span> <span class="ss">:terms</span> <span class="k">do</span>
    <span class="n">validates_acceptance_of</span> <span class="ss">:terms</span><span class="p">,</span> <span class="ss">:privacy_policy</span>
  <span class="k">end</span>
  <span class="n">validations</span> <span class="ss">:confirmation</span> <span class="k">do</span>
    <span class="n">validates_confirmation_of</span> <span class="ss">:password</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><p>And then when you save a model, you can specify what sets to use.</p>
<div class="highlight"><pre><code class="ruby"><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
<span class="n">user</span><span class="o">.</span><span class="n">valid?</span><span class="p">(</span><span class="ss">:terms</span><span class="p">,</span> <span class="ss">:confirmation</span><span class="p">)</span>
<span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="ss">:terms</span><span class="p">,</span> <span class="ss">:conditions</span><span class="p">)</span>
<span class="c1"># or all, possibly the default</span>
<span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span>
</code></pre></div><p>I could also see this being used for a wizard like interface.</p>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">Foo</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validations</span> <span class="ss">:step1</span> <span class="k">do</span>
    <span class="n">validates_presence_of</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:stuff</span><span class="p">,</span> <span class="ss">:thing</span>
  <span class="k">end</span>
  <span class="n">validations</span> <span class="ss">:step2</span> <span class="k">do</span>
    <span class="n">validates_presence_of</span> <span class="ss">:bar</span><span class="p">,</span> <span class="ss">:baz</span>
    <span class="n">validates_acceptance_of</span> <span class="ss">:terms</span>
  <span class="k">end</span>
  <span class="n">validations</span> <span class="ss">:step3</span> <span class="k">do</span>
    <span class="n">validates_confirmation_of</span> <span class="ss">:password</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><h3>But that shouldn&#8217;t really be part of the model</h3>
<p>You&#8217;re right, these problems really don&#8217;t concern the model. The model shouldn&#8217;t care were it is being created from, or if it&#8217;s being created in one step or five.  So what about going to the opposite end of the spectrum, and completely removing validations from the model and declaring them in observer-like classes.</p>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">TermsValidation</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Validations</span>
  <span class="n">validate</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">:supplier</span>

  <span class="n">validates_acceptance_of</span> <span class="ss">:terms</span><span class="p">,</span> <span class="ss">:privacy_policy</span><span class="p">,</span> <span class="ss">:on</span> <span class="o">=&gt;</span> <span class="ss">:create</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Step1Validation</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Validations</span>
  <span class="n">validate</span> <span class="ss">:foo</span>

  <span class="n">validates_presence_of</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:stuff</span><span class="p">,</span> <span class="ss">:thing</span>
<span class="k">end</span>
</code></pre></div><p>And then in the controller:</p>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validate</span> <span class="ss">:terms</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">save</span>
      <span class="c1"># all the validations passed</span>
    <span class="k">else</span>
      <span class="c1"># a validation failed, handle just like you would normally</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><p>If we had an action that required different validations than the rest of the controller, we could also use  similar approach to what we talked about earlier and declare what validations to use:</p>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validate</span> <span class="ss">:terms</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="n">user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">,</span> <span class="ss">:step2</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><p>I like this better, because choosing what set of validations to use does seem more like a controller decision, and not model one, but it is the model&#8217;s responsibility to make sure that the data is &#8220;valid&#8221;, so how do we reconcile this?</p>
<p>How are you working around this problem? Is there an obvious solution that I&#8217;m just not seeing?</p></div>

  <div id="be-social">
    <a href="https://twitter.com/share" class="twitter-share-button" data-via="bkeepers" data-lang="en" data-related="bkeepers">Tweet</a>
    <a href="https://twitter.com/bkeepers" class="twitter-follow-button" data-show-count="false" data-lang="en">Follow @bkeepers</a>
  </div>
</article>


<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  </div>

  <div id="about">
    <section>
      <p>I am <strong>Brandon Keepers</strong>. I build Internet things, usually with Ruby or JavaScript. I work at <a href="http://github.com">GitHub</a> and live in Holland, MI.</p>

      <ul id="links">
        <li>
          <a href="http://twitter.com/bkeepers">
            <span class="icon icon-mark-twitter"></span>
            Follow me on Twitter
          </a>
        </li>
        <li>
          <a href="http://github.com/bkeepers">
            <span class="icon icon-mark-github"></span>
            Follow me on GitHub
          </a>
        </li>
        <li>
          <a href="http://feeds.feedburner.com/opensoul">
            <span class="icon icon-feed"></span>
            Subscribe to the Feed
          </a>
        </li>
      </ul>
    </section>

    <section id="popular">
      <h1>Popular Posts</h1>
      <ul>
      
        <li><a href="/2012/06/05/whats-it-like-to-work-at-github/">What's it like to work at GitHub?</a></li>
      
        <li><a href="/2012/05/23/why-our-code-smells/">Why Our Code Smells</a></li>
      
        <li><a href="/2012/01/12/getting-started-with-sublime-text-2/">Getting Started with Sublime Text 2</a></li>
      
        <li><a href="/2012/01/09/the-40-standup-desk/">The $40 Standup Desk</a></li>
      
        <li><a href="/2011/11/30/haml-the-unforgivable-sin/">HAML: the unforgivable sin</a></li>
      
      </ul>
    </section>

  </div>

  <footer id="copyright">
    Copyright Â© 2006 - 2013 Brandon Keepers
  </footer>
</div>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-817617-1");
pageTracker._trackPageview();
} catch(err) {}
</script>

<script type="text/javascript">
  (function() {
    var t = document.createElement('script');
    t.type = 'text/javascript'; t.async = true;
    t.id = 'gauges-tracker'; t.setAttribute('data-site-id', '4d5c434255da1271e4000002');
    t.src = 'http://gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>
</body>
</html>
