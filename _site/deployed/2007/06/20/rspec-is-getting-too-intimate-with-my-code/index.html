<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RSpec is getting too intimate with my code</title>
  <meta name="description" content="a blog about code">
  <meta name="author" content="Brandon Keepers">
  <meta name="verify-v1" content="UwU5mecrHiDTPVlphLl729aaRCmyz93jrs+ER3RP4Pw=">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="google-site-verification" content="h4QNmQOrsvnIEsMH5GS3s4_jV3ZAZgrEoZdL4RsbOMI" />

  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link rel="stylesheet" href="/assets/site-38babed8aca4145f270d32a60b23d16d.css">

  <link rel="openid.server" href="http://www.myopenid.com/server">
  <link rel="openid.delegate" href="http://bkeepers.myopenid.com/">
  <link href="http://feeds.feedburner.com/opensoul" rel="alternate" title="opensoul.org" type="application/atom+xml">

  <!-- FIXME:  -->
</head>
<body>
<div class="container">
  <header>
    <h1><a href="/">opensoul.org</a></h1>
  </header>

  <div id="content">
    <article>
  <h1 class="small">RSpec is getting too intimate with my code</h1>
  <p class="meta">
    <span class="date">June 20, 2007</span>
    <span class="tags">
      
        rails,
      
        rspec,
      
        ruby,
      
        testing
      
    </span>
  </p>
  <div class="body"><p>The theory is that tests are supposed to be agnostic of the implementation. This leads to less brittle tests and actually tests the outcome (or behavior).</p>
<p>With RSpec, I feel like the common approach of completely mocking your models to test your controllers ends up forcing you to look too much into the implementation of your controller.</p>
<p>Here is an example of a spec that is generated by the rspec_scaffold generator:</p>
<div class="highlight"><pre><code class="ruby"><span class="n">describe</span> <span class="no">ThingsController</span><span class="p">,</span> <span class="s2">&quot;handling POST /things&quot;</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="vi">@thing</span> <span class="o">=</span> <span class="n">mock_model</span><span class="p">(</span><span class="no">Thing</span><span class="p">,</span> <span class="ss">:to_param</span> <span class="o">=&gt;</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="ss">:save</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
    <span class="no">Thing</span><span class="o">.</span><span class="n">stub!</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="vi">@thing</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">do_post</span>
    <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:thing</span> <span class="o">=&gt;</span> <span class="vi">@params</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;should create a new thing&quot;</span> <span class="k">do</span>
    <span class="no">Thing</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="vi">@params</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="vi">@thing</span><span class="p">)</span>
    <span class="n">do_post</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;should redirect to the new thing&quot;</span> <span class="k">do</span>
    <span class="n">do_post</span>
    <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="vi">@thing</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><p>This by itself is not too bad, but the problem is that it peers too much into the controller to dictate how the model is used.  Why does it matter if my controller calls <code>Thing.new</code>?  What if my controller decides to take the <code>Thing.create!</code> and <code>rescue</code> route? What if my model has a special initializer method, like <code>Thing.build_with_foo</code>? My spec for <em>behavior</em> should not fail if I change the implementation.</p>
<p>This problem gets even worse when you have nested resources and are creating multiple models per controller.  Some of my setup methods end up being 15 or more lines long and <span class="caps">VERY</span> fragile.</p>
<p>RSpec&#8217;s intention is to completely isolate your controller logic from your models, which sounds good in theory, but almost runs against the grain for an integrated stack like Rails. Especially if you practice the skinny controller/fat model discipline, the amount of logic in the controller becomes very small, and the setup becomes huge.</p>
<p>So what&#8217;s a <span class="caps">BDD</span>-wannabe to do?  Taking a step back, the <em>behavior</em> that I really want to test is not that my controller calls <code>Thing.new</code>, but that given parameters <em>X</em>, it creates a new thing and redirects to it.</p>
<p>Here&#8217;s the approach I&#8217;ve been taking:</p>
<div class="highlight"><pre><code class="ruby"><span class="c1"># spec_helper.rb</span>
<span class="k">def</span> <span class="nf">valid_thing_attrs</span><span class="p">(</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{})</span>
  <span class="p">{</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Foo&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># things_controller_spec.rb</span>
<span class="n">describe</span> <span class="no">ThingsController</span><span class="p">,</span> <span class="s2">&quot;handling POST /things&quot;</span> <span class="k">do</span>

  <span class="k">def</span> <span class="nf">do_post</span>
    <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:thing</span> <span class="o">=&gt;</span> <span class="n">valid_thing_attrs</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;should create a new thing&quot;</span> <span class="k">do</span>
    <span class="nb">lambda</span> <span class="p">{</span> <span class="n">do_post</span> <span class="p">}</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span> <span class="p">{</span> <span class="no">Thing</span><span class="o">.</span><span class="n">count</span> <span class="p">}</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;should redirect to the new thing&quot;</span> <span class="k">do</span>
    <span class="n">do_post</span>
    <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="vi">@thing</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><p>My spec is now testing that posting certain attributes creates a new thing (in the database) and redirects to it. You&#8217;ll notice that I have a method called <code>valid_thing_attrs</code>.  I don&#8217;t remember where I picked up this pattern, but it is something that has allowed me to minimize all of my test&#8217;s dependencies on the model.</p>
<p>My spec is now somewhat dependent on my model–and thus will break if my model gets hosed–but that is a small price to pay, in my opinion, for an implementation-agnostic spec with significantly less overhead.</p>
<p>What do you think?</p></div>

  <div id="be-social">
    <a href="https://twitter.com/share" class="twitter-share-button" data-via="bkeepers" data-lang="en" data-related="bkeepers">Tweet</a>
    <a href="https://twitter.com/bkeepers" class="twitter-follow-button" data-show-count="false" data-lang="en">Follow @bkeepers</a>
  </div>
</article>


<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  </div>

  <div id="about">
    <section>
      <p>I am <strong>Brandon Keepers</strong>. I build Internet things, usually with Ruby or JavaScript. I work at <a href="http://github.com">GitHub</a> and live in Holland, MI.</p>

      <p id="links">
        <a href="http://twitter.com/bkeepers" class="icon icon-mark-twitter" title="Follow me on Twitter"></a>
        <a href="http://github.com/bkeepers" class="icon icon-mark-github" title="Follow me on GitHub"></a>
        <a href="http://feeds.feedburner.com/opensoul" class="icon icon-feed" title="Subscribe to the Feed"></a>
      </p>
    </section>

    <section id="popular">
      <h1>Popular Posts</h1>
      <ul>
      
        <li><a href="/2014/04/28/failure/">Lessons learned from a cancelled project</a></li>
      
        <li><a href="/2012/06/05/whats-it-like-to-work-at-github/">What's it like to work at GitHub?</a></li>
      
        <li><a href="/2012/05/23/why-our-code-smells/">Why Our Code Smells</a></li>
      
        <li><a href="/2012/01/09/the-40-standup-desk/">The $40 Standup Desk</a></li>
      
        <li><a href="/2011/11/30/haml-the-unforgivable-sin/">HAML: the unforgivable sin</a></li>
      
      </ul>

      <p><a href="/archives">View All Posts</a></p>
    </section>

  </div>

  <footer id="copyright">
    Copyright © 2006 - 2013 Brandon Keepers
  </footer>
</div>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-817617-1");
pageTracker._trackPageview();
} catch(err) {}
</script>

<script type="text/javascript">
  (function() {
    var t = document.createElement('script');
    t.type = 'text/javascript'; t.async = true;
    t.id = 'gauges-tracker'; t.setAttribute('data-site-id', '4d5c434255da1271e4000002');
    t.src = 'http://gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>
</body>
</html>
