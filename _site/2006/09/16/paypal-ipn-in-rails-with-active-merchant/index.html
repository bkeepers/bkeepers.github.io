<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Paypal IPN in Rails with Active Merchant</title>
  <meta name="description" content="a blog about code">
  <meta name="author" content="Brandon Keepers">
  <meta name="verify-v1" content="UwU5mecrHiDTPVlphLl729aaRCmyz93jrs+ER3RP4Pw=">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="google-site-verification" content="h4QNmQOrsvnIEsMH5GS3s4_jV3ZAZgrEoZdL4RsbOMI" />

  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link rel="stylesheet" href="/assets/site-94e1fc1109c1b76ae4fbab0891861760.css">

  <link rel="openid.server" href="http://www.myopenid.com/server">
  <link rel="openid.delegate" href="http://bkeepers.myopenid.com/">
  <link href="http://feeds.feedburner.com/opensoul" rel="alternate" title="opensoul.org" type="application/atom+xml">

  <!-- FIXME:  -->
</head>
<body>
<div class="container">
  <header>
    <h1><a href="/">opensoul.org</a></h1>
  </header>

  <div id="content">
    <article>
  <h1 class="small">Paypal IPN in Rails with Active Merchant</h1>
  <p class="meta">
    <span class="date">September 16, 2006</span>
    <span class="tags">
      
        active_merchant,
      
        paypal,
      
        popular,
      
        rails
      
    </span>
  </p>
  <div class="body"><p><a href="http://home.leetsoft.com/am/">Active Merchant</a> makes it extremely simple to use Paypal <abbr title="Instant Payment Notification"><span class="caps">IPN</span></abbr>. Here is a simple guide for getting <span class="caps">IPN</span> up and running.</p>
<h3>Sign up for a <a href="https://developer.paypal.com/">Paypal sandbox account</a></h3>
<p>Paypal provides a sandbox environment that mimics their production environment, with the exception that it doesn&#8217;t actually process the transactions.  This is extremely useful for development and testing.  It allows you to create multiple fake accounts and generate bank accounts and credit cards. More information can be found on Paypal&#8217;s <a href="http://www.paypal.com/cgi-bin/webscr?cmd=_ipn-test-about-outside">Testing Instant Payment Notification</a> page.</p>
<p>Unfortunately, I&#8217;ve signed up for two different developer accounts and I&#8217;ve had trouble logging in with both of them.  I&#8217;ve tried resetting my password, but I still can&#8217;t log in.  Fortunately, I already have my sandbox accounts set up and don&#8217;t really have a need for it (except to write this guide).</p>
<h3>Create a Personal account and add a credit card</h3>
<p>After you sign up for your developer account, create a personal sandbox account and add a credit card.</p>
<h3>Create a Business account and add a checking</h3>
<p>Next, create a business sandbox account and add a checking account.</p>
<h3>Install the money gem</h3>
<pre>sudo gem install money</pre>
<h3>Install the Active Merchant plugin</h3>
<pre>script/plugin install http://activemerchant.googlecode.com/svn/trunk/active_merchant</pre>
<h3>Create a form that submits to Paypal</h3>
<p>Include <code>ActiveMerchant::Billing::Integrations</code> in a controller to add Active Merchant&#8217;s helpers.</p>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">PaymentsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="kp">include</span> <span class="no">ActiveMerchant</span><span class="o">::</span><span class="no">Billing</span><span class="o">::</span><span class="no">Integrations</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@enrollment</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">enrollments</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><p>In the view, use <code>payment_service_for</code> to create a form that submits to Paypal to process the payment.</p>
<div class="highlight"><pre><code class="erb"><span class="cp">&lt;%</span> <span class="n">payment_service_for</span> <span class="vi">@enrollment</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="no">PAYPAL_ACCOUNT</span><span class="p">,</span>
        <span class="ss">:amount</span> <span class="o">=&gt;</span> <span class="vi">@enrollment</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">deposit</span><span class="p">,</span> <span class="ss">:currency</span> <span class="o">=&gt;</span> <span class="s1">&#39;USD&#39;</span><span class="p">,</span>
        <span class="ss">:service</span> <span class="o">=&gt;</span> <span class="ss">:paypal</span> <span class="k">do</span> <span class="o">|</span><span class="n">service</span><span class="o">|</span>

    <span class="n">service</span><span class="o">.</span><span class="n">customer</span> <span class="ss">:first_name</span> <span class="o">=&gt;</span> <span class="vi">@enrollment</span><span class="o">.</span><span class="n">student</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span>
        <span class="ss">:last_name</span> <span class="o">=&gt;</span> <span class="vi">@enrollment</span><span class="o">.</span><span class="n">student</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span>
        <span class="ss">:phone</span> <span class="o">=&gt;</span> <span class="vi">@enrollment</span><span class="o">.</span><span class="n">student</span><span class="o">.</span><span class="n">phone</span><span class="p">,</span>
        <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="vi">@enrollment</span><span class="o">.</span><span class="n">student</span><span class="o">.</span><span class="n">email</span>
    <span class="n">service</span><span class="o">.</span><span class="n">billing_address</span> <span class="ss">:city</span> <span class="o">=&gt;</span> <span class="vi">@enrollment</span><span class="o">.</span><span class="n">student</span><span class="o">.</span><span class="n">city</span><span class="p">,</span>
        <span class="ss">:address1</span> <span class="o">=&gt;</span> <span class="vi">@enrollment</span><span class="o">.</span><span class="n">student</span><span class="o">.</span><span class="n">street</span><span class="p">,</span>
        <span class="ss">:state</span> <span class="o">=&gt;</span> <span class="vi">@enrollment</span><span class="o">.</span><span class="n">student</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
        <span class="ss">:country</span> <span class="o">=&gt;</span> <span class="s1">&#39;USA&#39;</span><span class="p">,</span>
        <span class="ss">:zip</span> <span class="o">=&gt;</span> <span class="vi">@enrollment</span><span class="o">.</span><span class="n">student</span><span class="o">.</span><span class="n">zip</span>
    <span class="n">service</span><span class="o">.</span><span class="n">item_name</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@enrollment</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">program</span><span class="si">}</span><span class="s2"> Deposit&quot;</span>
    <span class="n">service</span><span class="o">.</span><span class="n">invoice</span> <span class="vi">@enrollment</span><span class="o">.</span><span class="n">invoice</span><span class="o">.</span><span class="n">id</span>
    <span class="n">service</span><span class="o">.</span><span class="n">tax</span> <span class="s1">&#39;0.00&#39;</span>

    <span class="n">service</span><span class="o">.</span><span class="n">notify_url</span> <span class="n">url_for</span><span class="p">(</span><span class="ss">:only_path</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">:action</span> <span class="o">=&gt;</span> <span class="s1">&#39;notify&#39;</span><span class="p">)</span>
    <span class="n">service</span><span class="o">.</span><span class="n">return_url</span> <span class="n">url_for</span><span class="p">(</span><span class="ss">:only_path</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span>
        <span class="ss">:controller</span> <span class="o">=&gt;</span> <span class="s1">&#39;account&#39;</span><span class="p">,</span> <span class="ss">:action</span> <span class="o">=&gt;</span> <span class="s1">&#39;show&#39;</span><span class="p">)</span>
    <span class="n">service</span><span class="o">.</span><span class="n">cancel_return_url</span> <span class="n">url_for</span><span class="p">(</span><span class="ss">:only_path</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span>
        <span class="ss">:controller</span> <span class="o">=&gt;</span> <span class="s1">&#39;account&#39;</span><span class="p">,</span> <span class="ss">:action</span> <span class="o">=&gt;</span> <span class="s1">&#39;show&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">    &lt;!-- display payment summary here --&gt;</span>

<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">submit_tag</span> <span class="s1">&#39;Make Payment&#39;</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</code></pre></div><p>The code above refers to the constant <code>PAYPAL_ACCOUNT</code>, which I define in <code>environment.rb</code>.  I also set Active Merchant to use test mode, which directs it to use Paypal&#8217;s sandbox:</p>
<div class="highlight"><pre><code class="ruby"><span class="k">unless</span> <span class="no">RAILS_ENV</span> <span class="o">==</span> <span class="s1">&#39;production&#39;</span>
  <span class="no">PAYPAL_ACCOUNT</span> <span class="o">=</span> <span class="s1">&#39;sandboxaccount@example.com&#39;</span>
  <span class="no">ActiveMerchant</span><span class="o">::</span><span class="no">Billing</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="ss">:test</span>
<span class="k">else</span>
  <span class="no">PAYPAL_ACCOUNT</span> <span class="o">=</span> <span class="s1">&#39;paypalaccount@example.com&#39;</span>
<span class="k">end</span>
</code></pre></div><h3>Create an action that processes the <span class="caps">IPN</span></h3>
<p>After the above form submits to Paypal and the user makes a payment, Paypal will post data about the transaction to your server.  Set up an action to receive the post:</p>
<div class="highlight"><pre><code class="ruby">  <span class="k">def</span> <span class="nf">notify</span>
    <span class="n">notify</span> <span class="o">=</span> <span class="no">Paypal</span><span class="o">::</span><span class="no">Notification</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">raw_post</span><span class="p">)</span>
    <span class="n">enrollment</span> <span class="o">=</span> <span class="no">Enrollment</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">notify</span><span class="o">.</span><span class="n">item_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">notify</span><span class="o">.</span><span class="n">acknowledge</span>
      <span class="vi">@payment</span> <span class="o">=</span> <span class="no">Payment</span><span class="o">.</span><span class="n">find_by_confirmation</span><span class="p">(</span><span class="n">notify</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">)</span> <span class="o">||</span>
        <span class="n">enrollment</span><span class="o">.</span><span class="n">invoice</span><span class="o">.</span><span class="n">payments</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:amount</span> <span class="o">=&gt;</span> <span class="n">notify</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
          <span class="ss">:payment_method</span> <span class="o">=&gt;</span> <span class="s1">&#39;paypal&#39;</span><span class="p">,</span> <span class="ss">:confirmation</span> <span class="o">=&gt;</span> <span class="n">notify</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">,</span>
          <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="n">notify</span><span class="o">.</span><span class="n">params</span><span class="o">[</span><span class="s1">&#39;item_name&#39;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:status</span> <span class="o">=&gt;</span> <span class="n">notify</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
          <span class="ss">:test</span> <span class="o">=&gt;</span> <span class="n">notify</span><span class="o">.</span><span class="n">test?</span><span class="p">)</span>
      <span class="k">begin</span>
        <span class="k">if</span> <span class="n">notify</span><span class="o">.</span><span class="n">complete?</span>
          <span class="vi">@payment</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">notify</span><span class="o">.</span><span class="n">status</span>
        <span class="k">else</span>
          <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to verify Paypal&#39;s notification, please investigate&quot;</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
        <span class="vi">@payment</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;Error&#39;</span>
        <span class="k">raise</span>
      <span class="k">ensure</span>
        <span class="vi">@payment</span><span class="o">.</span><span class="n">save</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">render</span> <span class="ss">:nothing</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="k">end</span>
</code></pre></div><p>Depending on the model for your application, this action will obviously look different. The important part is that you pass the raw post data from the request to <code>Paypal::Notification.new</code>, and call <code>notify.acknowledge</code> to connect back to Paypal to verify the data.</p>
<h3>Enable <span class="caps">IPN</span></h3>
<p>Lastly, log into the business account that you created above, go to <em>&#8220;Instant Payment Notification Preferences&#8221;</em> in your profile, and set the <span class="caps">URL</span> that Paypal should post back to after payments. (Note: this needs to be a publicly accessible <span class="caps">URL</span>.)</p></div>

  <div id="be-social">
    <a href="https://twitter.com/share" class="twitter-share-button" data-via="bkeepers" data-lang="en" data-related="bkeepers">Tweet</a>
    <a href="https://twitter.com/bkeepers" class="twitter-follow-button" data-show-count="false" data-lang="en">Follow @bkeepers</a>
  </div>
</article>


<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  </div>

  <div id="about">
    <section>
      <p>I am <strong>Brandon Keepers</strong>. I build Internet things, usually with Ruby or JavaScript. I work at <a href="http://github.com">GitHub</a> and live in Holland, MI.</p>

      <ul id="links">
        <li>
          <a href="http://twitter.com/bkeepers">
            <span class="icon icon-mark-twitter"></span>
            Follow me on Twitter
          </a>
        </li>
        <li>
          <a href="http://github.com/bkeepers">
            <span class="icon icon-mark-github"></span>
            Follow me on GitHub
          </a>
        </li>
        <li>
          <a href="http://feeds.feedburner.com/opensoul">
            <span class="icon icon-feed"></span>
            Subscribe to the Feed
          </a>
        </li>
      </ul>
    </section>

    <section id="popular">
      <h1>Popular Posts</h1>
      <ul>
      
        <li><a href="/2012/06/05/whats-it-like-to-work-at-github/">What's it like to work at GitHub?</a></li>
      
        <li><a href="/2012/05/23/why-our-code-smells/">Why Our Code Smells</a></li>
      
        <li><a href="/2012/01/12/getting-started-with-sublime-text-2/">Getting Started with Sublime Text 2</a></li>
      
        <li><a href="/2012/01/09/the-40-standup-desk/">The $40 Standup Desk</a></li>
      
        <li><a href="/2011/11/30/haml-the-unforgivable-sin/">HAML: the unforgivable sin</a></li>
      
      </ul>
    </section>

  </div>

  <footer id="copyright">
    Copyright © 2006 - 2013 Brandon Keepers
  </footer>
</div>

<!--
FIXME:

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-817617-1");
pageTracker._trackPageview();
} catch(err) {}
</script>

<script type="text/javascript">
  (function() {
    var t = document.createElement('script');
    t.type = 'text/javascript'; t.async = true;
    t.id = 'gauges-tracker'; t.setAttribute('data-site-id', '4d5c434255da1271e4000002');
    t.src = 'http://gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>
-->
</body>
</html>
